name: PR Automation

on:
  pull_request:
    types: [opened, edited, synchronize, labeled, unlabeled, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Auto-label based on changed files
  label-files:
    name: Label by Files Changed
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Label PR based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: false

  # Auto-label based on branch name
  label-branch:
    name: Label by Branch Name
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Label PR based on branch name
        uses: TimonVS/pr-labeler-action@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/pr-labeler.yml

  # Validate PR title follows conventional commits
  validate-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Require conventional commit format
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          # Require scope to be lowercase
          requireScope: false
          # Disallow WIP in title
          disallowScopes: |
            wip
          # Validate the subject
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the PR title "{title}"
            should start with a lowercase letter.

            Examples of valid titles:
            - feat: add user authentication
            - fix: resolve login bug
            - docs: update API documentation
          # Allow merge commits
          allowMergeCommits: true
          # Allow revert commits
          allowRevertCommits: true
          # Ignore dependabot PRs
          ignoreLabels: |
            dependencies
            automated

  # Check for required labels
  require-labels:
    name: Require Type Label
    runs-on: ubuntu-latest
    steps:
      - name: Check for type label
        uses: mheap/github-action-required-labels@v5
        with:
          mode: minimum
          count: 1
          labels: "bug, feature, chore, docs, refactor, performance, test, dependencies, ci, release"
          message: |
            This PR requires at least one type label.
            Please add one of the following labels: bug, feature, chore, docs, refactor, performance, test, dependencies, ci, release

            Labels are usually auto-applied based on your branch name pattern (e.g., feat/*, fix/*, etc.)

  # Check PR size and warn if too large
  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    steps:
      - name: Label PR size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: 10
          s_label: 'size/S'
          s_max_size: 100
          m_label: 'size/M'
          m_max_size: 500
          l_label: 'size/L'
          l_max_size: 1000
          xl_label: 'size/XL'
          fail_if_xl: false
          message_if_xl: |
            This PR is quite large! Consider breaking it into smaller PRs for easier review.

            Large PRs are harder to review thoroughly and may delay the merge process.
          files_to_ignore: |
            package-lock.json
            *.lock
            *.generated.*
            prisma/migrations/*

  # Validate PR description
  validate-description:
    name: Validate PR Description
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'edited'
    steps:
      - name: Check PR body
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const title = context.payload.pull_request.title || '';
            const errors = [];
            const warnings = [];

            // Check if description is too short
            if (body.length < 50) {
              errors.push('PR description is too short. Please provide more context about your changes.');
            }

            // Check if title is too short
            if (title.length < 10) {
              errors.push('PR title is too short. Please provide a more descriptive title.');
            }

            // Check if title is too long
            if (title.length > 72) {
              warnings.push('PR title is quite long. Consider keeping it under 72 characters.');
            }

            // Check for required sections (optional, just warnings)
            const hasDescription = body.includes('## Description') || body.includes('<!-- Provide a brief description');
            const hasTypeOfChange = body.includes('## Type of Change') || body.includes('Type of Change');

            if (!hasDescription) {
              warnings.push('Consider adding a "Description" section to explain your changes.');
            }

            if (!hasTypeOfChange) {
              warnings.push('Consider using the PR template to specify the type of change.');
            }

            // Check for common issues
            if (title.toUpperCase() === title && title.length > 10) {
              errors.push('Please do not use ALL CAPS in the PR title.');
            }

            if (title.startsWith('WIP') || title.includes('[WIP]')) {
              warnings.push('This PR appears to be a work in progress. Mark it as a draft instead.');
            }

            // Output results
            if (errors.length > 0 || warnings.length > 0) {
              let message = '';

              if (errors.length > 0) {
                message += '## Errors\n\n';
                errors.forEach(e => message += `- ${e}\n`);
                message += '\n';
              }

              if (warnings.length > 0) {
                message += '## Warnings\n\n';
                warnings.forEach(w => message += `- ${w}\n`);
              }

              // Create or update comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

              const botComment = comments.find(c =>
                c.user.type === 'Bot' &&
                c.body.includes('PR Validation')
              );

              const commentBody = `## PR Validation\n\n${message}`;

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
              } else if (errors.length > 0) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
              }

              if (errors.length > 0) {
                core.setFailed('PR validation failed. Please fix the errors above.');
              }
            }
